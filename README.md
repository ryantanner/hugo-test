# viaduct.airbnb.tech

This readme documents how to develop and deploy viaduct.airbnb.tech.

## Stack

This is a Hugo/Docsy site. See the [Docsy documentation](https://www.docsy.dev/docs/getting-started/) for more information.

Ensure you have followed the [Docsy prerequisites](https://www.docsy.dev/docs/get-started/docsy-as-module/installation-prerequisites/).

### Customizations

There are a few custom shortcodes in the `layouts/_shortcodes` directory:

* `github`: Embeds a GitHub file in the documentation.
    ```markdown
    {{< github file="tenant/api/src/main/kotlin/viaduct/api/TenantModule.kt" maxHeight=1000 >}}
    {{< github "tenant/api/src/main/kotlin/viaduct/api/TenantModule.kt" branch="jsmith--test" >}}
    ```
    Both named and positional parameters are supported.
    Parameters:
  * `file`: The URL of the GitHub file to embed. Optionally append a line range, e.g. `#L10-L20` to embed only those lines.
  * `maxHeight`: The maximum height of the embedded file. Defaults to 500px.

### Development

To run the site locally, run:

```bash
hugo serve
```

Then open `http://localhost:1313` in your browser. If another process is bound to port 1313, hugo picks a random port and it will print the URL in the terminal.

### Deployment

Until we have CI for our site, deployment is manual.

```bash
cd $VIADUCT_REPO
./gradlew :docs:dokkaGenerate
cd docs
hugo build
VIADUCT_SITE_BUILD=`mktemp -d`
cp -r public/* $VIADUCT_SITE_BUILD
git checkout gh-pages
rm -rf * # Be careful with this command!
mv $VIADUCT_SITE_BUILD/* .
touch .nojekyll
git commit -am 'Publish new site version'
git push origin gh-pages
```

## Dokka

The docs site includes API documentation generated by [Dokka](https://kotlinlang.org/docs/dokka-overview.html) for the Viaduct codebase.

These are generated via Gradle:

```bash
./gradlew :docs:dokkaGenerate
```

That task outputs HTML files to `docs/static/api` and from there they are automatically included in the Hugo build.

To add another module to Dokka, add it to the `dependencies` block in `docs/build.gradle.kts`:

### Dokka module documentation

https://kotlinlang.org/docs/dokka-module-and-package-docs.html

Create a `module.md` file in the top-level of a module that is opted-in to Dokka. For example, `engine/api/module.md`. See link above for specific Markdown syntax.
